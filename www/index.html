<!--
    This file with the folder "assets" are mainly generated by Bootstrap Studio. https://bootstrapstudio.io/
    The random progress bar relies on https://gist.github.com/scaraux/cc993631cbc52966160fd294aea3fb54

    Other parts are all written or adjusted by Author.
-->
<!DOCTYPE html>
<html data-bs-theme="light" lang="en" style="--bs-primary: #fd800d;--bs-primary-rgb: 253,128,13;">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>Image Inpainting Task</title>
    <link rel="icon" type="image/svg+xml" sizes="200x200" href="assets/img/favicon.svg">
    <link rel="icon" type="image/svg+xml" sizes="200x200" href="assets/img/favicon.svg">
    <!--link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"-->
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.3.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="assets/css/bs-theme-overrides.css">
    <link rel="stylesheet" href="assets/css/Footer-Clean-icons.css">
    <link rel="stylesheet" href="assets/css/styles.css">
    <style>
        /*With the help of GPT4*/
        /* For Webkit browsers like Chrome, Safari, and newer versions of Edge */
        input[type="range"].form-range::-webkit-slider-thumb {
            background-color: #fd800d; /* Replace #yourColor with the color you want */
        }

        /* For Mozilla Firefox */
        input[type="range"].form-range::-moz-range-thumb {
            background-color: #fd800d; /* Replace #yourColor with the color you want */
        }

        /* For Microsoft Edge */
        input[type="range"].form-range::-ms-thumb {
            background-color: #fd800d; /* Replace #yourColor with the color you want */
        }
        
    </style>
</head>

<body>
    <header style="padding: 16px;background: #f1f1f1;">
        <h1 class="text-center" style="color: var(--bs-primary);font-weight: bold;">Image Inpainting Task Demo Web</h1>
    </header>

    <!--The container that holding the file loader button and example images-->
    <div id="ctn_index" class="container text-center" style="min-height: 450px;margin-top: 10px;margin-bottom: 10px;">
        <button id="upload_btn" class="btn btn-outline-primary row" type="button" style="width: 100%;height: 300px;border-radius: 45px;border-width: 2.8px;">
            <strong style="font-size: 20px;">Drag a image file here, or click to open file explorer</strong>
            <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 16 16" class="bi bi-upload">
                <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"></path>
                <path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z"></path>
            </svg>
        </button>
        <input type="file" id="file_selector" accept=".jpg, .jpeg, .png" style="display: none;"/>
        
        <strong style="color: var(--bs-primary);font-size: 20px;margin-top: 20px;">Alternately, click one image above to start&nbsp;</strong>
        <div class="row">
            <div class="col">
                <button id="img_btn_1" type="button" style="padding: 0px;border-radius: 0;border-style: none;margin: 10px;width: 15%;">
                    <img class="img-fluid" style="border-style: solid;border-color: var(--bs-primary);border-radius: 14px;" src="assets/img/example1.png">
                </button>
                <button id="img_btn_2" type="button" style="padding: 0px;border-radius: 0;border-style: none;margin: 10px;width: 15%;">
                    <img class="img-fluid" style="border-style: solid;border-color: var(--bs-primary);border-radius: 14px;" src="assets/img/exmaple2.png">
                </button>
                <button id="img_btn_3" type="button" style="padding: 0px;border-radius: 0;border-style: none;margin: 10px;width: 15%;">
                    <img class="img-fluid" style="border-style: solid;border-color: var(--bs-primary);border-radius: 14px;" src="assets/img/example3.png">
                </button>
                <button id="img_btn_4" type="button" style="padding: 0px;border-radius: 0;border-style: none;margin: 10px;width: 15%;">
                    <img class="img-fluid" style="border-style: solid;border-color: var(--bs-primary);border-radius: 14px;" src="assets/img/example4.png">
                </button>
                <button id="img_btn_5" type="button" style="padding: 0px;border-radius: 0;border-style: none;margin: 10px;width: 15%;">
                    <img class="img-fluid" style="border-style: solid;border-color: var(--bs-primary);border-radius: 14px;" src="assets/img/example5.png">
                </button>
                <button id="img_btn_6" type="button" style="padding: 0px;border-radius: 0;border-style: none;margin: 10px;width: 15%;">
                    <img class="img-fluid" style="border-style: solid;border-color: var(--bs-primary);border-radius: 14px;" src="assets/img/example6.png">
                </button>
            </div>
        </div>
        
    </div>

    <!--The container that holding the mask drawing functionalities-->
    <div id="ctn_draw" class="visually-hidden">
        <div class="container text-center" style="margin-top: 10px;margin-bottom: 10px;">
            <canvas id="draw_mask_cvs"></canvas>
        </div>
        <p style="text-align: center;color: var(--bs-primary);font-weight: bold;">Draw on the image of the region you want to be masked.</p>
        <div class="container d-flex justify-content-center" style="margin-top: 10px;margin-bottom: 10px;">
            <label class="col" for="brush_size_range" style="text-align: right;color: var(--bs-primary);width: 40px;">Brush Size</label>
            <input type="range" class="form-range col" min="0" max="100" step="1" value="24" id="brush_size_range" style="width: 30%;margin-left: 10px;margin-right: 10px;">
            <bold class="col" style="text-align: left;color: var(--bs-primary); width: 40px;" id="brush_size_displayer">24px</bold>
        </div>
        <div class="container d-flex justify-content-center">
            <button class="btn btn-primary" id="draw_back_btn" type="button" style="color: rgb(255,255,255);font-weight: bold;margin-left: 10px;margin-right: 10px;">Back</button>
            <button class="btn btn-outline-primary" id="draw_reset_btn" type="button" style="color: var(--bs-btn-color);font-weight: bold;margin-left: 10px;margin-right: 10px;">Reset</button>
            <button class="btn btn-primary" id="draw_next_btn" type="button" style="color: rgb(255,255,255);font-weight: bold;margin-left: 10px;margin-right: 10px;">Next</button>
        </div>
    </div>

    <!--The container that displaying the inpainting results-->
    <div id="ctn_display" class="visually-hidden">
        <div class="container">
            <div class="row">
                <div class="col-md-6 col" style="text-align: center;">
                    <p style="color: var(--bs-primary);font-weight: bold;font-size: 20px;margin-top: 16px;margin-bottom: 10px;">Input Image</p>
                    <button id="display_btn_1" type="button" style="padding: 0px;border-style: none;">
                        <img id="display_img_1" class="img-fluid" >
                    </button>
                </div>
                <div class="col" style="text-align: center;">
                    <p style="color: var(--bs-primary);font-weight: bold;font-size: 20px;margin-top: 16px;margin-bottom: 10px;">Mask</p>
                    <button id="display_btn_2" type="button" style="padding: 0px;border-style: none;">
                        <img id="display_img_2" class="img-fluid" >
                    </button>
                </div>
            </div>
        </div>
        <div class="container">
            <div class="row">
                <div class="col" style="text-align: center;">
                    <p style="color: var(--bs-primary);font-weight: bold;font-size: 20px;margin-top: 16px;margin-bottom: 10px;">Non-deep Learning (Telea pyheal)</p>
                    <button id="display_btn_3" type="button" style="padding: 0px;border-style: none;">
                        <img id="display_img_3" class="img-fluid" >
                    </button>
                </div>
                <div class="col" style="text-align: center;">
                    <p style="color: var(--bs-primary);font-weight: bold;font-size: 20px;margin-top: 16px;margin-bottom: 10px;">Deep Learning (Telea OpenCV)</p>
                    <button id="display_btn_4" type="button" style="padding: 0px;border-style: none;">
                        <img id="display_img_4" class="img-fluid" >
                    </button>
                </div>
                <div class="col" style="text-align: center;">
                    <p style="color: var(--bs-primary);font-weight: bold;font-size: 20px;margin-top: 16px;margin-bottom: 10px;">Deep Learning (LaMa)</p>
                    <button id="display_btn_5" type="button" style="padding: 0px;border-style: none;">
                        <img id="display_img_5" class="img-fluid" >
                    </button>
                </div>
            </div>
        </div>
        <div class="container text-center" style="padding-top: 30px;">
            <button class="btn btn-outline-primary" id="display_back_btn" type="button" style="color: var(--bs-btn-color);font-weight: bold;margin-right: 10px;margin-left: 10px;">Back</button>
            <button class="btn btn-primary" id="display_reset_btn" type="button" style="color: rgb(255,255,255);font-weight: bold;margin-right: 10px;margin-left: 10px;">Start New</button>
        </div>
    </div>


    <footer class="text-center py-4" style="position: static;background: #f0f0f0;margin-top: 25px;">
        <div class="container">
            <div class="row row-cols-1 row-cols-lg-3">
                <div class="col">
                    <p class="text-muted my-2">Copyright&nbsp;© 2023 Eric WANG</p>
                </div>
                <div class="col">
                    <ul class="list-inline my-2">
                        <li class="list-inline-item me-4">
                            <div class="bs-icon-circle bs-icon-primary bs-icon" style="background: var(--bs-primary);">
                                <a class="d-flex justify-content-center align-items-center" href="https://github.com/wpcjath" style="width: 100%;height: 100%;" target="_blank">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 16 16" class="bi bi-github" style="height: 12px;width: 12px;">
                                        <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 
                                                 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 
                                                 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 
                                                 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 
                                                 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 
                                                 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0
                                                 0 16 8c0-4.42-3.58-8-8-8z">
                                        </path>
                                    </svg>
                                </a>
                            </div>
                        </li>
                    </ul>
                </div>
                <div class="col">
                    <p class="text-muted my-2" style="color: var(--bs-primary);">1155200446@link.cuhk.edu.hk</p>
                </div>
            </div>
        </div>
    </footer>

    <!--The modal for image viewer-->
    <div class="modal fade" role="dialog" tabindex="-1" id="large_image_modal">
        <div class="modal-dialog modal-lg modal-fullscreen" role="document">
            <div class="modal-content">
                <div class="modal-header" style="padding: 8px;padding-right: 12px;">
                    <button class="btn-close" type="button" aria-label="Close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <img class="img-fluid" loading="eager" style="width: 100%;">
                </div>
            </div>
        </div>
    </div>

    <!--The modal that displaying loading status-->
    <div class="modal fade" role="dialog" tabindex="-1" id="loading_modal">
        <div class="modal-dialog modal-lg modal-fullscreen" role="document">
            <div class="modal-content">
                <div class="modal-body d-flex justify-content-center align-items-center" style="background: #e4e4e4;">
                    <div class="col text-center" style="padding-right: 30%;padding-left: 30%;">
                        <span class="spinner-border" role="status" style="color: var(--bs-primary);width: 64px;height: 64px;border-width: 12.8px;"></span>
                        <div id="progress_bar" class="progress visually-hidden" style="margin-top: 20px;height: 22px;font-weight: bold;font-size: 17px;">
                            <div class="progress-bar bg-primary progress-bar-striped progress-bar-animated" aria-valuenow="50" aria-valuemin="0" aria-valuemax="100" style="width: 100%; color: rgb(0,0,0)">100%</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!--The modal that displays notices-->
    <div class="modal fade" role="dialog" tabindex="-1" id="message_modal">
        <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title"></h4>
                    <button class="btn-close" type="button" aria-label="Close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p style="font-size: 20px;"></p>
                </div>
                <div class="modal-footer">
                    <button id="ok_btn" class="btn btn-primary" type="button" data-bs-dismiss="modal" style="color: rgb(255,255,255);font-weight: bold;font-size: 16px;padding-right: 18px;padding-left: 18px;">OK</button>
                </div>
            </div>
        </div>
    </div>

    <!--script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script-->
    <script src="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.3.1/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script type="text/javascript">
        //// The global variables ////

        // Elements
        img_upload_ctn = $("#ctn_index");
        file_selector = $("#file_selector");
        img_draw_ctn = $("#ctn_draw");
        img_display_ctn = $("#ctn_display");
        msg_modal = $("#message_modal");
        large_img_modal = $("#large_image_modal");
        loading_modal = $("#loading_modal");

        upload_btn = $("#upload_btn");
        draw_back_btn = $("#draw_back_btn");
        draw_reset_btn = $("#draw_reset_btn");
        draw_next_btn = $("#draw_next_btn");

        display_back_btn = $("#display_back_btn");
        display_reset_btn = $("#display_reset_btn");

        draw_mask_cvs = document.getElementById('draw_mask_cvs');
        draw_mask_ctx = draw_mask_cvs.getContext('2d');

        // Variables
        let img = null;
        let img_file = null;
        let msk_file = null;
        let mask = null;
        let brunsh_color = "#fd800d";
        let brunsh_size = 24;
        let mask_identify_tolerance = 1.8;
        let process_id = null;
        let processing_finished_global = false;

        //// Event binding ////
        $(document).ready(function() 
        {
            upload_btn.click(() => {file_selector.click();})
            file_selector.change(handleFileSelection);

            ['dragenter', 'dragleave', 'dragover', 'drop'].forEach(name => 
            {
                addEventListener(name, handleFileDragDrop, false);
            });
            ['img_btn_1', 'img_btn_2', 'img_btn_3', 'img_btn_4', 'img_btn_5', 'img_btn_6'].forEach(btn => 
            {
                $('#' + btn).click(renderSampleImgOnCanvasa)
            });
            ['display_btn_1', 'display_btn_2', 'display_btn_3', 'display_btn_4', 'display_btn_5'].forEach(btn => 
            {
                $('#' + btn).click(display_large_image_modal)
            });
            $("#brush_size_range").change(() => {set_brush_size($("#brush_size_range").val())});

            draw_back_btn.click(display_upload_ctn);
            draw_next_btn.click(uploadImageMask);
            draw_reset_btn.click(resetCanvas);

            display_back_btn.click(display_draw_ctn);
            display_reset_btn.click(display_upload_ctn);

            draw_mask_cvs.addEventListener("mousedown", mouseDown, false);
            draw_mask_cvs.addEventListener("mouseup", endStroke, false);
            draw_mask_cvs.addEventListener("mouseout", endStroke, false);
            draw_mask_cvs.addEventListener("mouseenter", mouseEnter, false);

            set_brush_size(brunsh_size);
        });
        
        //// Display control functions ////
        function display_upload_ctn() 
        {
            file_selector.val('');
            img_draw_ctn.addClass("visually-hidden");
            img_display_ctn.addClass("visually-hidden");
            img_upload_ctn.removeClass("visually-hidden");
        }

        function display_draw_ctn() 
        {
            img_upload_ctn.addClass("visually-hidden");
            img_display_ctn.addClass("visually-hidden");
            img_draw_ctn.removeClass("visually-hidden");
        }

        function display_display_ctn(inpainted_img_1, inpainted_img_2, inpainted_img_3) 
        {
            $("#display_img_1").attr("src", URL.createObjectURL(img_file));
            $("#display_img_2").attr("src", URL.createObjectURL(mask_file)); 
            $("#display_img_3").attr("src", 'data:image/png;base64,' + inpainted_img_1);
            $("#display_img_4").attr("src", 'data:image/png;base64,' + inpainted_img_2);
            $("#display_img_5").attr("src", 'data:image/png;base64,' + inpainted_img_3);        

            img_upload_ctn.addClass("visually-hidden");
            img_draw_ctn.addClass("visually-hidden");
            img_display_ctn.removeClass("visually-hidden");
        }

        function display_message_modal(title, content, callback) 
        {
            msg_modal.find(".modal-title").text(title);
            msg_modal.find(".modal-body").text(content);
            msg_modal.modal("show");

            if (callback) {
                msg_modal.find("#ok_btn").click(()=>{
                    callback();
                    $(this).off('click');
                });
            }
        }

        function display_large_image_modal() 
        {
            large_img_modal.find(".modal-body img").attr("src", $(this).find('img').attr('src'));
            large_img_modal.modal("show");
        }

        function display_loading_modal() 
        {
            loading_modal.modal("show");
        }

        function hide_loading_modal() 
        {
            loading_modal.modal("hide");
        }

        function display_progress_bar(value=0) 
        {
            $("#progress_bar").removeClass("visually-hidden");
            $("#progress_bar .progress-bar").css("width", value + "%");
            $("#progress_bar .progress-bar").attr('aria-valuenow', value);
            $("#progress_bar .progress-bar").text(value + '%');
        }

        function hide_progress_bar() 
        {
            $("#progress_bar").addClass("visually-hidden");
        }

        function set_brush_size(size) 
        {
            brunsh_size = strokeWidth = size;
            $("#brush_size_displayer").text(size + "px");
        }

        //// Functionailites ////
        function handleFileSelection(event)
        {
            renderImageOnCanvas(fileValidation(event.target.files));
        }

        function handleFileDragDrop(event)
        {
            prevent_default_events(event);
            switch(event.type)
            {
                case "dragenter":
                    img_draw_ctn.addClass("active");
                    break;
                case "drop":
                    renderImageOnCanvas(fileValidation(event.dataTransfer.files));
                    break;
                default:
                    img_draw_ctn.removeClass("active");
                    return;
            }
        }

        function fileValidation(files)
        {
            files = Array.from(files);
            files = files.filter(f => 
                f.type === "image/jpeg" || 
                f.type === "image/png" ||
                f.type === "image/jpg"
            );

            if (files.length === 0) 
            {
                display_message_modal("Error", "Only support .png, .jpg, .jpeg files.");
                return null;
            }
            return files[0];
        }

        function renderSampleImgOnCanvasa()
        {
            drawImgOnCanvas($(this).find('img').attr('src'));
        }

        function renderImageOnCanvas(file)
        {
            if (file == null) return;
            let reader = new FileReader();
            reader.onload = () => {
                drawImgOnCanvas(reader.result);
            };
            reader.readAsDataURL(file);
        }

        function drawImgOnCanvas(src)
        {
            img = new Image();
            img.src = src;
            img.onload = () => {
                draw_mask_cvs.width = img.width;
                draw_mask_cvs.height = img.height;
                draw_mask_ctx.clearRect(0, 0, draw_mask_cvs.width, draw_mask_cvs.height);
                draw_mask_ctx.drawImage(img, 0, 0);
                display_draw_ctn();
            };
        }

        function resetCanvas()
        {
            draw_mask_ctx.clearRect(0, 0, draw_mask_cvs.width, draw_mask_cvs.height);
            draw_mask_ctx.drawImage(img, 0, 0);
        }

        async function uploadImageMask()
        {
            display_loading_modal();
            hide_progress_bar();

            await generateBinaryMask();
            let formData = new FormData();
            formData.append("image", img_file);
            formData.append("mask", mask_file);
            
            error_occured = false;
            process_id = null;
            $.ajax({
                url: "/upload",
                type: "POST",
                data: formData,
                processData: false,
                contentType: false,
                success: (res) => 
                {
                    if (res.result == "success") 
                    {
                        process_id = res.data;
                        console.log(process_id);
                    } 
                    else 
                    {
                        error_occured = true;
                        display_message_modal("error", res.data, display_upload_ctn);
                    }
                },
                error: () => {
                    error_occured = true;
                    display_message_modal("error", "Failed to upload the image and mask.", display_upload_ctn);
                }
            });
            
            processing_finished_global = false;
            randomProgress(0, 1000, 56, 108, 400, 500, (value) => {
                    display_progress_bar(value / 10);
            });

            let interval = setInterval(async () => {
                if (error_occured || !await queryResult()) {
                    processing_finished_global = true;
                    clearInterval(interval);
                    hide_loading_modal();
                    hide_progress_bar();
                }
                // console.log("querying");
            }, 5000);
        }

        async function queryResult() {
            if (!process_id) return true;
            onProcessing = true;
            error_occured = false;

            let formData = new FormData();
            formData.append("id", process_id);

            $.ajax({
                url: "/result",
                type: "POST",
                data: formData,
                processData: false,
                contentType: false,
                success: (res) => 
                {
                    if (res.result == "success") 
                    {
                        display_progress_bar(100);
                        // console.log(res.data);
                        display_display_ctn(res.data.img1, res.data.img2, res.data.img3);
                        onProcessing = false;
                        return;
                    } 
                    if (res.result == "error") 
                    {
                        display_message_modal("Error", res.data, display_upload_ctn);
                        error_occured = true;
                        return;
                    } 
                    onProcessing = true;
                },
                error: () => {
                    display_message_modal("Error", "Failed to query the result.", display_upload_ctn);
                    error_occured = true;
                }
            });

            return new Promise((resolve) => {
                let interval = setInterval(() => {
                if (!onProcessing || error_occured) {
                    clearInterval(interval);
                    resolve(false);
                }
                }, 100);
            });
        }

        async function generateBinaryMask() {
            let blend_pixels = draw_mask_ctx.getImageData(0, 0, draw_mask_cvs.width, draw_mask_cvs.height).data;
            let mask_pixels = new Uint8ClampedArray(blend_pixels.length);

            for (let i = 0; i < blend_pixels.length; i += 4) 
            {
                // dec format of the paint color #fd800d, a "hot-fix" solution
                if (euclidean_distance(blend_pixels[i], blend_pixels[i + 1], blend_pixels[i + 2], 253, 128, 13) < mask_identify_tolerance) 
                {
                    mask_pixels[i] = 255;
                    mask_pixels[i + 1] = 255;
                    mask_pixels[i + 2] = 255;
                } 
                else 
                {
                    mask_pixels[i] = 0;
                    mask_pixels[i + 1] = 0;
                    mask_pixels[i + 2] = 0;
                }
                mask_pixels[i + 3] = 255;
            }

            // Use a offscreen canvas to convert the mask data, cannot think of other better ways
            let temp_cvs = new OffscreenCanvas(draw_mask_cvs.width, draw_mask_cvs.height);
            let temp_ctx = temp_cvs.getContext('2d');
            temp_ctx.putImageData(new ImageData(mask_pixels, draw_mask_cvs.width, draw_mask_cvs.height), 0, 0);
            mask = new Image();
            let mask_blob = await temp_cvs.convertToBlob();
            mask.onload = function() {
                URL.revokeObjectURL(this.src);
            }
            mask.src = URL.createObjectURL(mask_blob);
            mask_file = new File([mask_blob], "mask.png", {type: 'image/png'});

            temp_ctx.clearRect(0, 0, draw_mask_cvs.width, draw_mask_cvs.height);
            temp_ctx.drawImage(img, 0, 0);
            let img_blob = await temp_cvs.convertToBlob();
            img_file = new File([img_blob], "image.png", {type: 'image/png'});
        }

        function euclidean_distance(x1, x2, x3, y1, y2, y3) {
            return Math.sqrt(Math.pow(x1 - y1, 2) + Math.pow(x2 - y2, 2) + Math.pow(x3 - y3, 2));
        }

        

        //// Util functions ////
        function prevent_default_events(e)
        {
            e.preventDefault();
            e.stopPropagation();
        }


        //// The random progress bar from https://gist.github.com/scaraux/cc993631cbc52966160fd294aea3fb54 ////
        /**
         * 
         * @param {*} minValue The value we start the progress from
         * @param {*} maxValue The value we terminate the progress at
         * @param {*} minIncrease The minimum amount we should increase with
         * @param {*} maxIncrease The maximum amount we should increase with
         * @param {*} minWaitMs The minimum wait between each increase
         * @param {*} maxWaitMs The maximum wait between each increase
         * @param {*} callback The callback to notify each increase
         * @param {*} value Used to pass value along recursion
         */
        async function randomProgress(minValue, maxValue, minIncrease, maxIncrease, minWaitMs, maxWaitMs, callback, value=0) {
            let currentValue = Math.max(value, minValue);
            callback(currentValue);
            if (currentValue === maxValue || processing_finished_global) return;
            const randomIncrease = Math.floor(Math.random() * maxIncrease) + minIncrease;
            currentValue += (currentValue + randomIncrease > maxValue) ? (maxValue - currentValue) : randomIncrease;
            await new Promise(r => setTimeout(r, (Math.random() * maxWaitMs) + minWaitMs));
            await randomProgress(minValue, maxValue, minIncrease, maxIncrease, minWaitMs, maxWaitMs, callback, currentValue)
        }


        /// Canvas drawing functionalities from https://dev.to/ascorbic/a-more-realistic-html-canvas-paint-tool-313b ///

        // Brush colour and size
        const colour = brunsh_color;
        let strokeWidth = brunsh_size;

        // Drawing state
        let latestPoint;
        let drawing = false;

        // Set up our drawing context
        const canvas = draw_mask_cvs // document.getElementById("canvas");
        const context = draw_mask_ctx;

        // Drawing functions

        const continueStroke = newPoint => {
            context.beginPath();
            context.moveTo(latestPoint[0], latestPoint[1]);
            context.strokeStyle = colour;
            context.lineWidth = strokeWidth;
            context.lineCap = "round";
            context.lineJoin = "round";
            context.lineTo(newPoint[0], newPoint[1]);
            context.stroke();

            latestPoint = newPoint;
        };

        // Event helpers

        const startStroke = point => {
            drawing = true;
            latestPoint = point;
        };

        const BUTTON = 0b01;
        const mouseButtonIsDown = buttons => (BUTTON & buttons) === BUTTON;

        // Event handlers

        const mouseMove = evt => {
            if (!drawing) {
                return;
            }
            continueStroke([evt.offsetX, evt.offsetY]);
        };

        const mouseDown = evt => {
            if (drawing) {
                return;
            }
            evt.preventDefault();
            canvas.addEventListener("mousemove", mouseMove, false);
            startStroke([evt.offsetX, evt.offsetY]);
        };

        const mouseEnter = evt => {
            if (!mouseButtonIsDown(evt.buttons) || drawing) {
                return;
            }
            mouseDown(evt);
        };

        const endStroke = evt => {
            if (!drawing) {
                return;
            }
            drawing = false;
            evt.currentTarget.removeEventListener("mousemove", mouseMove, false);
        };

    </script>
</body>

</html>